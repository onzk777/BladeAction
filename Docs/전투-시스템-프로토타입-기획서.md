## 전투 시스템 기획서 (Ver. 1.2)

### 개요
- **방식**: 순차 턴제(Sequential Turn-Based)
- **턴 구성**: 플레이어와 NPC가 교대로 매 턴 하나의 명령(Command)을 선택하며, 선택 즉시 실행
- **핵심 입력**: 모든 액션은 애니메이션 진행과 연동된 **타이밍 입력(Perfect Timing Command)** 기반으로 판정됨
- **영향 범위**: 입력 성공/실패는 피해량, 자세(포이즈) 게이지, 연계/중단, 연출 등 전반에 영향을 미침

### 기본 전투 구조
| 요소 | 설명 |
|---|---|
| 전투 방식 | 순차 턴제(Sequential Turn-Based) |
| 커맨드 선택 | 턴당 1개 명령(Command) 선택 후 즉시 실행 |
| 턴 진행 | 플레이어 ↔ NPC 교대 수행 |
| 타이밍 입력 | 각 히트마다 입력 윈도우가 존재, 성공 시 Perfect 판정 |
| 자동 판정 | AI는 난이도/확률 기반으로 입력을 자동 처리, 플레이어 입력은 실시간 판정 |

### 커맨드 종류(예시)
- 베기(수평/수직), 찌르기, 방어, 비기(오의, 조건부 사용)

### 액션 판정 규칙(업데이트)

입력 가능 구간과 히트별 퍼펙트 윈도우의 개념적 타임라인:

```
Buffer Start |  Hit 1 [ P ]  |   Hit 2 [ P ]  |  Hit 3 [ P ]  | Buffer End
           └────────────── 실제 입력 가능 시간 구간 ───────────────┘
```

1) 공격 실행
- 선택한 `ActionCommand`를 실행하여 피해/자세 게이지 등에 영향을 준다.
- 커맨드마다 히트 수와 각 히트의 윈도우가 다르며, 히트마다 개별 판정과(필요 시) 쳐내기 기회를 부여한다.
- 각 히트의 연출/실행 시점은 해당 히트의 타이밍 판정 종료 시점을 기준으로 마무리된다.

2) 방어자 상태
- 공격자의 연속 윈도우 동안 방어자는 다음 중 하나를 시도할 수 있다: `막기(Guard)`, `회피(Dodge)`, `쳐내기(Parry)`(히트별)
- 입력이 없거나 실패하면 기본 피격 처리(피해/자세 게이지 감소)가 적용된다.
- UI 프롬프트로 현재 상태(입력 가능/윈도우 오픈 등)를 안내한다.

3) 쳐내기(Parry)
- 히트의 퍼펙트 윈도우 내 정확 입력 시 **Perfect Parry**가 발생할 수 있다.
- 성공 시: 공격이 즉시 중단되거나 대폭 약화되고, 공격자 자세 게이지가 크게 감소한다.
- 실패 시: 기본 피격보다 불리한 리스크(예: 추가 피해/자세 감소)가 있을 수 있다.

4) 필살기(오의)
- 조건 충족 시 사용 가능하며 일부 방어 행위를 **무시**하거나 감쇠한다는 특성을 가질 수 있다.
- 프로토타입 단계에서는 조건/무시 범위를 설정값으로 제어한다.

5) 동시 판정 제거
- 동시 타격/동시 입력의 최종 동시 판정은 사용하지 않는다.
- 실제 입력 타임스탬프와 상태(행동 중 여부)에 따라 순차적으로 판정한다.

### 자세(포이즈) 시스템
턴/행동 중 각 캐릭터는 자세(포이즈) 게이지를 관리한다. 개념적 규칙은 아래와 같다.

| 항목 | 내용 |
|-----|------|
| 시작/회복 | 각 턴 시작 시 일정 포인트 회복(설정값 기반) |
| 맞기/방어 | 피격/방어 시 자세 게이지가 감소. 방어 성공 시 감소량이 경감됨 |
| 쳐내기 성공 | 상대의 공격을 중단시키며 상대 자세 게이지에 큰 패널티 부여 |
| 붕괴 상태 | 자세가 임계 이하로 떨어지면 일시적 무력화/행동 제한(설정에 따름) |

### 연타 공격 & 쳐내기
- 하나의 커맨드가 여러 히트로 구성될 수 있으며 히트마다 개별 타이밍 윈도우와 판정이 존재한다.
- 각 히트는 독립적으로 막기/회피/쳐내기 판정을 가질 수 있다.
- 연타 도중 성공적인 쳐내기 발생 시, 공격이 중단되거나 다음 히트가 약화된다(설정에 따름).

### AI 입력 판정 방식
- 확률 기반 일반형: `perfectInputChance` 계수를 사용해 확률적으로 퍼펙트 입력을 시도
- 패턴 기반 강제형: 특정 커맨드는 지정된 히트에서 퍼펙트를 강제

```json
{
  "perfectInputChance": 0.25,
  "forcePerfectPattern": [2, 4]
}
```

### 연출 설계(Visual)
| 요소 | 내용 |
|---|---|
| 타이밍 안내 | 프롬프트/게이지/효과로 입력 가능 상태를 명확히 노출 |
| 입력 성공 | VFX/사운드/카메라 리액션 |
| 쳐내기/경직 | 강한 손맛: 화면 흔들림, 순간 슬로우, 특화 애니메이션 |

### 클래스 구조(개념)
- `abstract Combatant`: 공통 속성/이벤트/커맨드 셋 관리 베이스
- `PlayerCombatant`: 플레이어 입력/상태 처리
- `EnemyCombatant`: AI 커맨드 선택/상태 및 쳐내기/자세 로직 포함

필요 시 코드 기준 참조: `CombatManager`, `AttackerInputHandler`, `DefenderInputHandler`, `InputVersusResult`, `CombatStatusDisplay`, `GlobalConfig`, `ActionCommandData`, `SwordArtStyleData`.


