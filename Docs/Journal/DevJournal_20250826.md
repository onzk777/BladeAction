## 🎯 **오늘 진행할 구현 계획 (2025-08-26)**

### **📋 Feature List**

#### **🎬 애니메이션 시스템**
1. **피격 애니메이션** - 방어자가 피격당할 때 애니메이션 재생 (완벽 입력 종료 시점)
2. **패리 성공 애니메이션** - 방어자가 완벽 입력 성공 시 패리 애니메이션 재생
3. **패리 당함 애니메이션** - 공격자가 패리에 당하면 액션 중단 애니메이션 재생

#### **⚔️ 전투 시스템**
4. **방어 입력 시스템** - Key Hold 형태의 방어 입력 구현 (스페이스바 사용)
5. **액션 중단 처리** - 공격자가 패리에 당했을 때 액션 즉시 중단
6. **중단 후 대기 시간** - GlobalConfig에 WaitTimeAfterActionInterrupt 설정 추가

---

### **🔧 구현 계획**

#### **1단계: 방어 입력 시스템 구현 (우선순위 높음)**
- `CombatManager`의 기본 방어 on 설정을 false로 변경
- 방어 입력을 위한 Key Hold 시스템 구현
- 방어 모드 활성화/비활성화 로직 구현

#### **2단계: 액션 중단 처리 시스템 구현**
- `InputVersusResult`에서 패리 판정 시 공격자 액션 중단 로직 구현
- 중단 시 현재 액션 즉시 종료 처리
- 이후 타격 수행 차단 로직 구현

#### **3단계: 중단 후 대기 시간 시스템**
- `GlobalConfig`에 `WaitTimeAfterActionInterrupt` Float 데이터 추가
- 액션 중단 후 설정된 시간만 대기하고 턴 종료 처리
- 턴 종료까지 남은 시간을 모두 대기하지 않도록 수정

#### **4단계: 애니메이션 연결**
- `OnBeHitted()` 메소드에 실제 Spine 애니메이션 재생 로직 구현
- `OnSuccessParry()` 메소드에 실제 Spine 애니메이션 재생 로직 구현
- `OnInterrupted()` 메소드에 실제 Spine 애니메이션 재생 로직 구현

---

### **📅 오늘 작업 순서**

1. **방어 입력 시스템 구현** (기본 구조)
2. **액션 중단 처리 로직 구현** (핵심 기능)
3. **GlobalConfig 설정 추가** (WaitTimeAfterActionInterrupt)
4. **중단 후 대기 시간 처리** (턴 종료 로직)
5. **애니메이션 메소드 연결** (Spine 애니메이션 재생)

**목표: 오늘 하루 안에 방어 시스템과 액션 중단 시스템의 기본 구조를 완성하고, 애니메이션 연결까지 마무리하는 것!** 🚀

---

## 🎯 **오늘 완료된 작업 내용 (2025-08-26)**

### **✅ 완료된 주요 기능들**

#### **1. 막기(Guard) 시스템 구현** ✅
- **목표 달성**: 기존 하드코딩된 `guard = true` 로직을 제거하고 동적 막기 시스템 구현
- **구현 내용**:
  - `DefenderInputHandler`에 막기 상태 관리 로직 추가
  - 방어 턴일 때만 막기 입력 인식 및 활성화
  - 공격/쳐내기 입력 키를 0.5초 이상 홀드하면 막기 활성화
  - 입력 키를 Release하면 즉시 막기 비활성화
- **테스트 결과**: ✅ 성공, 기능 확인 완료

#### **2. AI 완벽 입력 문제 해결** ✅
- **문제 해결**: AI가 항상 완벽 입력을 성공하는 문제
- **원인 파악**: `BaseInputHandler`에서 AI 입력 확률이 제대로 반영되지 않음
- **해결 방법**: `aiInputIsPerfect` 필드 추가하여 AI 입력 확률 처리 로직 수정
- **테스트 결과**: ✅ 성공, `GlobalConfig` 설정이 제대로 반영됨

#### **3. 액션 중단(Action Interruption) 시스템 구현** ✅
- **목표 달성**: "자세 포인트" 기반의 액션 중단 시스템 구현
- **구현 내용**:
  - `Combatant` 클래스에 자세 포인트 관리 로직 추가
  - `GlobalConfig`에 자세 포인트 관련 설정 추가
  - `CombatManager`에 중단 로직 및 턴 조기 종료 기능 구현
  - `DefenderInputHandler`에서 자세 포인트 0일 때 막기 제한
- **설정 값**:
  - `posturePointsMax`: 자세 포인트 최대치
  - `posturePointsLossOnParry`: 쳐내기 당했을 때 자세 포인트 감소량
  - `interruptWaitSec`: 중단 후 턴 종료까지 대기 시간

#### **4. 중단 애니메이션 재생 시스템 구현** ✅
- **목표 달성**: 중단 발생 시 "interrupted" 애니메이션 재생
- **구현 내용**:
  - `AnimationNameTable`에 "interrupted" 애니메이션 이름 정의
  - `PlayerController`와 `EnemyController`에 `OnInterrupted()` 메서드 구현
  - Spine 애니메이션 시스템과 연동

#### **5. Spine 애니메이션 애셋 연결 시스템 구현** ✅
- **목표 달성**: 게임 시작 시 장착된 유파의 Spine 애니메이션 애셋 자동 연결
- **구현 내용**:
  - `ConnectSpineAnimationAsset()` 메서드로 Spine 애셋 자동 연결
  - `SkeletonAnimation` 컴포넌트에 Spine 애셋 설정

### **🔧 발생한 문제들과 해결 과정**

#### **문제 1: 코드 누락 및 사이드 이펙트**
- **상황**: AI 모델의 코드 편집 과정에서 기존 정상 동작 코드가 누락됨
- **원인**: `apply_model`이 코드 변경사항을 제대로 적용하지 못함
- **해결**: 수동으로 코드 복구 및 내부 규칙 수립
- **교훈**: 기존 정상 동작 코드는 절대 수정하지 말 것

#### **문제 2: Spine 애니메이션 재생 실패**
- **상황**: 공격 애니메이션이 재생되지 않음
- **원인**: `OnPlayActionCommand()`에서 하드코딩된 `ActionCommands[0]` 사용
- **해결**: `GetSelectedCommand()` 메서드 사용으로 테스트 설정 반영
- **교훈**: 기존 로직의 의도를 파악하지 못하고 불필요하게 구조를 바꾼 것이 문제

#### **문제 3: FloatingText MissingReferenceException**
- **상황**: `FloatingText` 오브젝트가 파괴된 상태에서 `gameObject`에 접근
- **원인**: `CleanupFromList` 코루틴에서 null 체크 부족
- **해결**: 더 엄격한 null 체크 추가 (`floatingText != null && floatingText.gameObject != null`)

#### **문제 4: 중단 애니메이션 이름 불일치**
- **상황**: "interrupted" 애니메이션을 찾을 수 없음
- **원인**: Spine 애셋 연결 문제 또는 애니메이션 이름 불일치
- **상태**: 애니메이션 재생은 확인됨, 상태 머신 처리는 향후 구현 예정

### **📁 수정된 파일들**

1. **`Assets/Script/Combat/CombatManager.cs`** - 액션 중단 시스템, 막기 시스템 통합
2. **`Assets/Script/Combat/DefenderInputHandler.cs`** - 막기 시스템, 자세 포인트 제한
3. **`Assets/Script/Combat/BaseInputHandler.cs`** - AI 입력 확률 처리 수정
4. **`Assets/Script/GlobalConfig.cs`** - 자세 포인트 시스템 설정 추가
5. **`Assets/Script/Combatant.cs`** - 자세 포인트 관리 로직 추가
6. **`Assets/Script/Combat/ICombatController.cs`** - `GetSelectedCommand()` 메서드 추가
7. **`Assets/Script/Controller/PlayerController.cs`** - 중단 애니메이션, Spine 애셋 연결
8. **`Assets/Script/Controller/EnemyController.cs`** - 중단 애니메이션, Spine 애셋 연결
9. **`Assets/Script/UI/FloatingTextManager.cs`** - null 체크 강화

### **📋 내부 규칙 수립**

#### **코드 수정 시 준수사항:**
1. **기존 정상 동작 코드는 절대 수정하지 않음**
2. **수정이 필요한 부분을 먼저 파악하고 사용자에게 확인 요청**
3. **"작동하는 코드가 최고의 코드" 원칙 준수**
4. **불필요한 리팩토링 지양**

---

## 🎯 **내일 수행 계획표 (2025-08-27)**

### **📋 오늘 계획했으나 구현하지 못한 내용 종합**

#### **1. 애니메이션 시스템 미완성 부분**
- ❌ `OnBeHitted()` - 피격 애니메이션 재생 로직
- ❌ `OnSuccessParry()` - 쳐내기 성공 애니메이션 재생 로직  
- ❌ `OnPlayDefence()` - 방어 애니메이션 재생 로직

#### **2. 전투 시스템 연결 미완성 부분**
- ❌ `InputVersusResult`와 애니메이션 메서드 연결
- ❌ 피격/쳐내기/방어 판정 시점에서의 애니메이션 호출

#### **3. 애니메이션 상태 머신 미완성 부분 (필수)**
- ❌ 중단 후 idle로 돌아가는 상태 전환
- ❌ 애니메이션 간 자연스러운 전환 처리
- ❌ 상태 기반 애니메이션 관리 시스템

---

### **🚀 내일 핵심 목표: 애니메이션 상태 머신 기반 시스템 완성**

#### **1단계: 애니메이션 상태 머신 설계 및 구현 (우선순위 최고)**
- **목표**: 전투 상태에 따른 애니메이션 전환 시스템 구축
- **구현 내용**:
  - `AnimationStateManager` 클래스 설계
  - 상태별 애니메이션 매핑 테이블 구성
  - 상태 전환 시 자연스러운 애니메이션 전환 로직
- **예상 효과**: 애니메이션 시스템의 확장성과 안정성 대폭 향상

#### **2단계: 미완성 애니메이션 메서드 완성 (우선순위 높음)**
- **목표**: 기본 애니메이션 메서드들의 실제 재생 로직 구현
- **구현 내용**:
  - `OnBeHitted()` - 피격 애니메이션 재생 로직 완성
  - `OnSuccessParry()` - 쳐내기 성공 애니메이션 재생 로직 완성
  - `OnPlayDefence()` - 방어 애니메이션 재생 로직 완성
- **예상 효과**: 전투 시스템의 시각적 피드백 완성

#### **3단계: 전투 시스템과 애니메이션 연결 (우선순위 높음)**
- **목표**: `InputVersusResult` 기반의 자동 애니메이션 호출 시스템
- **구현 내용**:
  - `CombatManager`에서 전투 결과에 따른 자동 애니메이션 호출
  - 피격/쳐내기/방어 판정 시점에서의 애니메이션 연결
  - 상태 머신과 연동된 애니메이션 전환
- **예상 효과**: 전투와 애니메이션의 완벽한 동기화

#### **4단계: 애니메이션 상태 전환 최적화 (우선순위 중간)**
- **목표**: 애니메이션 간 자연스러운 전환과 상태 관리
- **구현 내용**:
  - 중단 후 idle로 돌아가는 상태 전환 로직
  - 애니메이션 재생 완료 후 자동 상태 전환
  - 상태 충돌 방지 및 우선순위 관리
- **예상 효과**: 부드럽고 자연스러운 애니메이션 경험

---

### **📅 내일 작업 순서 및 시간 배분**

#### **오전 (09:00-12:00)**
1. **애니메이션 상태 머신 설계** (2시간)
   - `AnimationStateManager` 클래스 구조 설계
   - 상태별 애니메이션 매핑 테이블 설계
2. **기본 구조 구현** (1시간)
   - 클래스 및 인터페이스 생성

#### **오후 (13:00-17:00)**
1. **상태 머신 핵심 로직 구현** (2시간)
   - 상태 전환 로직 구현
   - 애니메이션 전환 처리
2. **미완성 애니메이션 메서드 완성** (2시간)
   - `OnBeHitted()`, `OnSuccessParry()`, `OnPlayDefence()` 구현

#### **저녁 (18:00-20:00)**
1. **전투 시스템과 애니메이션 연결** (1.5시간)
   - `CombatManager` 연동
   - 자동 애니메이션 호출 시스템
2. **테스트 및 최적화** (0.5시간)
   - 상태 전환 테스트
   - 애니메이션 동기화 확인

---

### **🎯 내일 완성 목표**

#### **필수 완성 항목**
- ✅ **애니메이션 상태 머신 시스템** - 전투 상태 기반 애니메이션 관리
- ✅ **기본 애니메이션 메서드들** - 피격, 쳐내기, 방어 애니메이션
- ✅ **전투-애니메이션 연결** - 자동 애니메이션 호출 시스템

#### **선택 완성 항목**
- 🔄 **애니메이션 전환 최적화** - 자연스러운 상태 전환
- 🔄 **상태 충돌 방지** - 애니메이션 우선순위 관리

---

### **💡 내일 작업의 핵심 포인트**

1. **애니메이션 상태 머신이 핵심**: 이를 기반으로 모든 애니메이션 시스템이 확장됨
2. **확장성 고려**: 향후 새로운 애니메이션이나 상태 추가 시 쉽게 확장 가능한 구조
3. **성능 최적화**: 불필요한 애니메이션 전환 방지 및 효율적인 상태 관리
4. **사용자 경험**: 부드럽고 자연스러운 애니메이션 전환으로 몰입감 향상

**내일은 애니메이션 상태 머신을 기반으로 한 완성도 높은 애니메이션 시스템을 구축하는 것이 목표입니다!** 🎬✨
